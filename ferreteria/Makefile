.PHONY: help build up down logs restart clean test

# ============================================
# Makefile - Comandos √∫tiles para Docker
# ============================================

# Variables
COMPOSE = docker-compose
DOCKER = docker
CONTAINER_API = tallersag-api
CONTAINER_DB = tallersag-mongodb

help: ## Mostrar esta ayuda
	@echo "üê≥ Comandos disponibles para Docker:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

# ============================================
# Comandos de control
# ============================================

up: ## Iniciar todos los servicios
	$(COMPOSE) up -d
	@echo "‚úÖ Servicios iniciados"
	@echo "üìå API: http://localhost:3001"
	@echo "üìå MongoDB: mongodb://localhost:27017"

down: ## Detener todos los servicios
	$(COMPOSE) down
	@echo "‚úÖ Servicios detenidos"

restart: ## Reiniciar todos los servicios
	$(COMPOSE) restart
	@echo "‚úÖ Servicios reiniciados"

rebuild: ## Reconstruir las im√°genes sin cach√©
	$(COMPOSE) build --no-cache
	@echo "‚úÖ Im√°genes reconstruidas"

rebuild-up: rebuild up ## Reconstruir e iniciar servicios

# ============================================
# Logs
# ============================================

logs: ## Ver logs de todos los servicios
	$(COMPOSE) logs -f

logs-api: ## Ver logs de la API
	$(COMPOSE) logs -f api

logs-db: ## Ver logs de MongoDB
	$(COMPOSE) logs -f mongodb

logs-tail: ## √öltimas 50 l√≠neas de logs
	$(COMPOSE) logs --tail=50

# ============================================
# Gesti√≥n de servicios
# ============================================

ps: ## Ver estado de los contenedores
	$(COMPOSE) ps

stats: ## Ver estad√≠sticas de recursos
	$(DOCKER) stats

shell-api: ## Acceder a la shell de la API
	$(COMPOSE) exec api sh

shell-db: ## Acceder a la shell de MongoDB
	$(COMPOSE) exec mongodb mongosh

# ============================================
# MongoDB
# ============================================

db-connect: ## Conectar a MongoDB
	$(COMPOSE) exec mongodb mongosh

db-backup: ## Hacer backup de la base de datos
	@mkdir -p backups
	$(DOCKER) run --rm -v tallersag_mongodb_data:/data -v $(PWD)/backups:/backups mongo:6.0-alpine \
		mongodump --out=/backups/dump_$(shell date +%Y%m%d_%H%M%S)
	@echo "‚úÖ Backup realizado"

# ============================================
# Desarrollo
# ============================================

install: ## Instalar dependencias en el contenedor
	$(COMPOSE) exec api pnpm install

add: ## Instalar un paquete (usar: make add PKG=nombre-paquete)
	$(COMPOSE) exec api pnpm add $(PKG)

add-dev: ## Instalar un paquete de desarrollo (usar: make add-dev PKG=nombre-paquete)
	$(COMPOSE) exec api pnpm add -D $(PKG)

test: ## Ejecutar tests
	$(COMPOSE) exec api pnpm test

# ============================================
# Limpieza
# ============================================

clean: ## Detener servicios y limpiar vol√∫menes
	$(COMPOSE) down -v
	@echo "‚úÖ Servicios y vol√∫menes eliminados"

clean-images: ## Eliminar im√°genes de Docker
	$(DOCKER) rmi $$($(DOCKER) images -q)
	@echo "‚úÖ Im√°genes eliminadas"

prune: ## Limpiar todo lo no utilizado
	$(DOCKER) system prune -f
	@echo "‚úÖ Sistema limpiado"

# ============================================
# Informaci√≥n
# ============================================

info: ## Mostrar informaci√≥n de los servicios
	@echo "üê≥ Estado de Servicios:"
	@$(COMPOSE) ps
	@echo ""
	@echo "üìä Recursos utilizados:"
	@$(DOCKER) stats --no-stream

version: ## Ver versiones de Docker
	@echo "Docker version:"
	@$(DOCKER) --version
	@echo "Docker Compose version:"
	@$(COMPOSE) --version

# ============================================
# Valores por defecto
# ============================================

.DEFAULT_GOAL := help
